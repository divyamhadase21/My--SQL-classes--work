
-- Section A- DDL 
drop database GroceryShopDB;
-- 1
CREATE DATABASE GroceryShopDB;
USE GroceryShopDB;

-- 2
-- Customers
CREATE TABLE Customers (
  CustomerID INT AUTO_INCREMENT PRIMARY KEY,
  Name VARCHAR(100) NOT NULL,
  Email VARCHAR(150) UNIQUE,
  Phone VARCHAR(20),
  City VARCHAR(100),
  CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Suppliers
CREATE TABLE Suppliers (
  SupplierID INT AUTO_INCREMENT PRIMARY KEY,
  SupplierName VARCHAR(150) NOT NULL,
  ContactName VARCHAR(100),
  Phone VARCHAR(20),
  City VARCHAR(100)
);

-- Products
CREATE TABLE Products (
  ProductID INT AUTO_INCREMENT PRIMARY KEY,
  ProductName VARCHAR(150) NOT NULL,
  Category VARCHAR(100),
  Price DECIMAL(10,2) NOT NULL CHECK (Price >= 0),
  StockQty INT NOT NULL DEFAULT 0,
  SupplierID INT,
  CONSTRAINT fk_products_supplier FOREIGN KEY (SupplierID) REFERENCES Suppliers(SupplierID)
);

-- Orders
CREATE TABLE Orders (
  OrderID INT AUTO_INCREMENT PRIMARY KEY,
  CustomerID INT NOT NULL,
  OrderDate DATETIME DEFAULT CURRENT_TIMESTAMP,
  TotalAmount DECIMAL(12,2) NOT NULL DEFAULT 0,
  Status VARCHAR(30) DEFAULT 'Pending',
  CONSTRAINT fk_orders_customer FOREIGN KEY (CustomerID) REFERENCES Customers(CustomerID)
);

-- OrderItems
CREATE TABLE OrderItems (
  OrderItemID INT AUTO_INCREMENT PRIMARY KEY,
  OrderID INT NOT NULL,
  ProductID INT NOT NULL,
  Quantity INT NOT NULL CHECK (Quantity > 0),
  SubTotal DECIMAL(12,2) NOT NULL,
  CONSTRAINT fk_orderitems_order FOREIGN KEY (OrderID) REFERENCES Orders(OrderID) ON DELETE CASCADE,
  CONSTRAINT fk_orderitems_product FOREIGN KEY (ProductID) REFERENCES Products(ProductID)
);

-- 3
ALTER TABLE Suppliers 
ADD UNIQUE (SupplierName);

ALTER TABLE Products
  ADD UNIQUE (ProductName);
  
-- 4
ALTER TABLE Products
ADD COLUMN Discount DECIMAL(5,2) DEFAULT 0.00;

-- 5
ALTER TABLE Products
DROP COLUMN Discount;

-- Section B – DML 

-- Suppliers (5)
INSERT INTO Suppliers (SupplierName, ContactName, Phone, City) VALUES
('FreshFarms Ltd', 'Amit Kumar', '9876501234', 'Delhi'),
('GreenLeaf Suppliers', 'Sara Mehra', '9876512345', 'Mumbai'),
('DailyGrocers', 'Ravi Patel', '9876523456', 'Lucknow'),
('Organic Roots', 'Priya Sen', '9876534567', 'Bengaluru'),
('Coastal Foods', 'John Dsouza', '9876545678', 'Chennai');

-- Customers (5)
INSERT INTO Customers (Name, Email, Phone, City) VALUES
('Sandeep Sharma','sandeep.sharma@example.com','9000000001','Delhi'),
('Simran Kaur','simran.kaur@example.com','9000000002','Mumbai'),
('Prerna Deshmukh','prerna.d@example.com','9000000003','Nashik'),
('Rohit Singh','rohit.singh@example.com','9000000004','Lucknow'),
('Anita Verma','anita.verma@example.com','9000000005','Delhi');

-- Products (5) — include SupplierID references (assumes Suppliers inserted IDs 1..5)
INSERT INTO Products (ProductName, Category, Price, StockQty, SupplierID) VALUES
('Basmati Rice 5kg','Grains', 450.00, 50, 1),
('Olive Oil 1L','Oils', 799.00, 30, 2),
('Almonds 500g','Dry Fruits', 1200.00, 20, 3),
('Whole Wheat Flour 5kg','Grains', 320.00, 60, 1),
('Peanut Butter 500g','Spreads', 350.00, 40, 4);

-- 7
-- Orders (3)
INSERT INTO Orders (CustomerID, OrderDate, TotalAmount, Status) VALUES
(1, NOW() - INTERVAL 2 DAY, 0.00, 'Pending'),  
(2, NOW() - INTERVAL 9 DAY, 0.00, 'Delivered'), 
(5, NOW() - INTERVAL 1 DAY, 0.00, 'Pending'); 

-- 8
-- OrderItems for OrderID 1 (Sandeep)
INSERT INTO OrderItems (OrderID, ProductID, Quantity, SubTotal) VALUES
(1, 1, 2, (SELECT Price FROM Products WHERE ProductID = 1) * 2),  
(1, 2, 1, (SELECT Price FROM Products WHERE ProductID = 2) * 1);  

-- OrderItems for OrderID 2 (Simran)
INSERT INTO OrderItems (OrderID, ProductID, Quantity, SubTotal) VALUES
(2, 5, 2, (SELECT Price FROM Products WHERE ProductID = 5) * 2);  

-- OrderItems for OrderID 3 (Anita)
INSERT INTO OrderItems (OrderID, ProductID, Quantity, SubTotal) VALUES
(3, 3, 1, (SELECT Price FROM Products WHERE ProductID = 3) * 1),  
(3, 4, 3, (SELECT Price FROM Products WHERE ProductID = 4) * 3);  

-- 9
-- Update products stock based on order items (for all existing orderitems)
UPDATE Products p
JOIN (
  SELECT ProductID, SUM(Quantity) AS QtySold
  FROM OrderItems
  GROUP BY ProductID
) oi ON p.ProductID = oi.ProductID
SET p.StockQty = p.StockQty - oi.QtySold;

-- 10
DELETE FROM Customers
WHERE City = 'Lucknow'
LIMIT 1;

 -- Section C – DQL (Data Query Language)
-- 11
SELECT * FROM Customers WHERE City = 'Delhi';

-- 12
SELECT * FROM Products WHERE Price > 500.00;

-- 13
SELECT City, COUNT(*) AS CustomerCount
FROM Customers
GROUP BY City;

-- 14
SELECT ProductID, ProductName, Price
FROM Products
ORDER BY Price DESC
LIMIT 3;

-- 15
SELECT * FROM Orders WHERE OrderDate >= NOW() - INTERVAL 7 DAY;

-- 16
SELECT c.*
FROM Customers c
LEFT JOIN Orders o ON c.CustomerID = o.CustomerID
WHERE o.OrderID IS NULL;

-- 17
SELECT p.ProductID, p.ProductName, s.SupplierName
FROM Products p
LEFT JOIN Suppliers s ON p.SupplierID = s.SupplierID;

-- 18
SELECT c.CustomerID, c.Name,
       COALESCE(SUM(o.TotalAmount), 0) AS TotalSales
FROM Customers c
LEFT JOIN Orders o ON c.CustomerID = o.CustomerID
GROUP BY c.CustomerID, c.Name;

SELECT c.CustomerID, c.Name,
       COALESCE(SUM(oi.SubTotal),0) AS TotalSales
FROM Customers c
LEFT JOIN Orders o ON c.CustomerID = o.CustomerID
LEFT JOIN OrderItems oi ON o.OrderID = oi.OrderID
GROUP BY c.CustomerID, c.Name;

-- Section D — Operators & Clauses
-- 19
SELECT * FROM Products WHERE Price BETWEEN 100 AND 1000;

-- 20
SELECT * FROM Customers WHERE Name LIKE 'S%';

-- 21
SELECT * FROM Customers WHERE City IN ('Delhi', 'Mumbai', 'Lucknow');

-- 22
SELECT City, COUNT(*) AS CustomerCount
FROM Customers
GROUP BY City
HAVING COUNT(*) > 2;

-- 23 
SELECT * FROM Products ORDER BY Price DESC;

-- Section E- Joins
-- 24
SELECT o.OrderID, c.Name AS CustomerName, o.OrderDate
FROM Orders o
INNER JOIN Customers c ON o.CustomerID = c.CustomerID;

-- 25
SELECT c.CustomerID, c.Name, o.OrderID, o.OrderDate, o.TotalAmount
FROM Customers c
LEFT JOIN Orders o ON c.CustomerID = o.CustomerID
ORDER BY c.CustomerID;

-- 26
SELECT p.ProductID, p.ProductName, oi.OrderItemID, oi.OrderID, oi.Quantity, oi.SubTotal
FROM OrderItems oi
RIGHT JOIN Products p ON oi.ProductID = p.ProductID
ORDER BY p.ProductID;

-- 27
-- Emulated FULL OUTER JOIN for Customers and Orders
SELECT c.CustomerID, c.Name, o.OrderID, o.OrderDate
FROM Customers c
LEFT JOIN Orders o ON c.CustomerID = o.CustomerID
UNION
SELECT c.CustomerID, c.Name, o.OrderID, o.OrderDate
FROM Customers c
RIGHT JOIN Orders o ON c.CustomerID = o.CustomerID;

-- Section F — Subqueries & Views
-- 28
SELECT DISTINCT c.*
FROM Customers c
WHERE c.CustomerID IN (
  SELECT o.CustomerID
  FROM Orders o
  JOIN OrderItems oi ON o.OrderID = oi.OrderID
  JOIN Products p ON oi.ProductID = p.ProductID
  WHERE p.Price > 1000
);

-- 29
CREATE VIEW CustomerOrdersView AS
SELECT c.CustomerID, c.Name AS CustomerName, o.OrderID, o.TotalAmount
FROM Customers c
JOIN Orders o ON c.CustomerID = o.CustomerID;

-- 30
SELECT *
FROM CustomerOrdersView
WHERE TotalAmount > 5000;

-- 31
SELECT * 
FROM CustomerOrdersView
where TotalAmount > 5000;

-- 31
SELECT p.ProductID, p.ProductName, p.Price
FROM Products p
WHERE p.Price > (
  SELECT AVG(Price) FROM Products
);

-- Section G — CTE
-- 33
WITH RECURSIVE seq(n) AS (
  SELECT 1
  UNION ALL
  SELECT n + 1 FROM seq WHERE n < 10
)
SELECT n FROM seq;

-- Section H — Functions
-- 34
-- Current date
SELECT CURDATE() AS TodayDate;

-- Uppercase all customer names
SELECT CustomerID, UPPER(Name) AS NameUpper FROM Customers;

-- Round product prices to nearest integer
SELECT ProductID, ProductName, ROUND(Price) AS PriceRounded FROM Products;

-- 35
DELIMITER //
CREATE FUNCTION GetDiscountedPrice(price DECIMAL(10,2))
RETURNS DECIMAL(10,2)
DETERMINISTIC
BEGIN
  RETURN ROUND(price * 0.90, 2);
END;
//
DELIMITER ;

-- 36
SELECT ProductID, ProductName, Price,
       GetDiscountedPrice(Price) AS PriceAfter10PctDiscount
FROM Products;

-- 40
-- Create DeletedCustomers log table
CREATE TABLE IF NOT EXISTS DeletedCustomers (
  DeletedID INT AUTO_INCREMENT PRIMARY KEY,
  CustomerID INT,
  Name VARCHAR(100),
  Email VARCHAR(150),
  Phone VARCHAR(20),
  City VARCHAR(100),
  DeletedAt DATETIME DEFAULT CURRENT_TIMESTAMP
);

DELIMITER //
CREATE TRIGGER LogDeletedCustomer
AFTER DELETE ON Customers
FOR EACH ROW
BEGIN
  INSERT INTO DeletedCustomers (CustomerID, Name, Email, Phone, City, DeletedAt)
  VALUES (OLD.CustomerID, OLD.Name, OLD.Email, OLD.Phone, OLD.City, NOW());
END;
//
DELIMITER ;

-- Section J — Stored Procedures
-- 41
DELIMITER //
CREATE PROCEDURE GetCustomerOrders(IN in_customer_id INT)
BEGIN
  SELECT o.OrderID, o.OrderDate, o.TotalAmount, o.Status
  FROM Orders o
  WHERE o.CustomerID = in_customer_id
  ORDER BY o.OrderDate DESC;
END;
//
DELIMITER ;

-- Section L — DCL & TCL
-- 48
CREATE USER IF NOT EXISTS 'grocery_admin'@'%' IDENTIFIED BY 'StrongPasswordHere!';
GRANT SELECT, INSERT ON GroceryShopDB.* TO 'grocery_admin'@'%';
FLUSH PRIVILEGES;

-- Section M — Normalization & Keys
-- 50
-- 1NF (First Normal Form)
-- 2NF (Second Normal Form)
-- 3NF (Third Normal Form)

-- Primary Keys
-- Customers(CustomerID) — PK: CustomerID
-- Suppliers(SupplierID) — PK: SupplierID
-- Products(ProductID) — PK: ProductID
-- Orders(OrderID) — PK: OrderID
-- OrderItems(OrderItemID) — PK: OrderID

-- Foreign Keys
-- Products.SupplierID → Suppliers.SupplierID
-- Orders.CustomerID → Customers.CustomerID
-- OrderItems.OrderID → Orders.OrderID
-- OrderItems.ProductID → Products.ProductID

-- Candidate Keys
-- For Customers, customerName could be candidate key.
-- For Products, ProductName could be candidate key.
-- For Suppliers, SupplierName could be cndidate key.





















  



